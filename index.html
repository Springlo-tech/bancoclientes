<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart√£o AR - Clientes</title>

    <!-- ‚úÖ A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        font-family: Arial, sans-serif;
      }
      #status {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: #00ffcc;
        padding: 8px 16px;
        border-radius: 10px;
        font-size: 14px;
      }
      #iniciarBtn {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #00ffcc;
        color: #000;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        cursor: pointer;
      }
      #iniciarBtn:hover {
        background: #00ccaa;
      }
    </style>
  </head>

  <body>
    <button id="iniciarBtn">Iniciar</button>
    <div id="status">[STATUS] Carregando...</div>

    <!-- ‚úÖ Cena AR -->
    <a-scene
      mindar-image="imageTargetSrc: ./mindar/ingrid.mind; filterMinCF:0.0001; filterBeta: 0.001;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <video
          id="videoCliente"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Alvo de imagem (target MindAR) -->
      <a-entity mindar-image-target="targetIndex: 0" id="targetIngrid">
        <a-video
          src="#videoCliente"
          position="0 0 0"
          rotation="0 0 0"
          width="1"
          height="0.80"
          autoplay="false"
          id="videoPlane"
        ></a-video>
      </a-entity>
    </a-scene>

    <!-- ‚úÖ Firebase (m√≥dulo) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAQaVmj1MBbIoOCod-vRZvG1Z4DGxo3ZO4",
        authDomain: "cartao-ar-clientes.firebaseapp.com",
        projectId: "cartao-ar-clientes",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // üîπ Cria fun√ß√£o global vis√≠vel fora do m√≥dulo
      window.buscarVideoCliente = async function (nomeClienteFirestore) {
        const q = query(
          collection(db, "clientes"),
          where("nome", "==", nomeClienteFirestore)
        );
        const snapshot = await getDocs(q);
        if (snapshot.empty)
          throw new Error(`Cliente '${nomeClienteFirestore}' n√£o encontrado.`);
        return snapshot.docs[0].data(); // { videourl: "..." }
      };

      // üîπ Marca quando estiver pronto
      window.firebaseReady = true;
    </script>

    <!-- ‚úÖ Script principal -->
    <script>
      const statusDiv = document.getElementById("status");
      const iniciarBtn = document.getElementById("iniciarBtn");
      const video = document.getElementById("videoCliente");
      const target = document.getElementById("targetIngrid");

      function setStatus(msg) {
        console.log("[STATUS]", msg);
        statusDiv.textContent = `[STATUS] ${msg}`;
      }

      // ‚úÖ Fun√ß√£o principal
      async function startForClient(nomeCliente) {
        try {
          setStatus(`Buscando v√≠deo do cliente: ${nomeCliente}...`);
          const data = await window.buscarVideoCliente(nomeCliente);
          if (!data?.videourl)
            throw new Error("Campo 'videourl' ausente no Firestore.");

          video.src = data.videourl;
          setStatus(`Cliente: ${nomeCliente}. Toque em Iniciar e aponte para a imagem.`);
        } catch (err) {
          console.error(err);
          setStatus("Erro Firestore: " + err.message);
        }
      }

      // ‚úÖ Inicializa√ß√£o com par√¢metro da URL
      async function boot() {
        const urlParams = new URLSearchParams(window.location.search);
        const cliente = urlParams.get("cliente");
        if (!cliente) {
          setStatus("Selecione um cliente para continuar.");
          return;
        }
        await startForClient(cliente);
      }

      // ‚úÖ Espera o Firebase estar pronto antes de iniciar
      (async function waitFirebase() {
        while (!window.firebaseReady) {
          await new Promise((r) => setTimeout(r, 50));
        }
        boot();
      })();

      // ‚úÖ Bot√£o "Iniciar" habilita som e v√≠deo
      iniciarBtn.addEventListener("click", async () => {
        try {
          video.muted = false;
          await video.play();
          setStatus("Som habilitado. Aponte a c√¢mera para a imagem.");
          iniciarBtn.style.display = "none";
        } catch (e) {
          console.warn("Falha ao iniciar v√≠deo:", e);
          setStatus("Toque novamente para liberar o v√≠deo.");
        }
      });

      // ‚úÖ Controle via MindAR: play/pause quando o marcador aparece/desaparece
      target.addEventListener("targetFound", () => {
        console.log("[MindAR] Marcador detectado.");
        if (!video.paused) return;
        video.play()
          .then(() => setStatus("üé¨ V√≠deo tocando"))
          .catch((e) => console.warn("Autoplay bloqueado:", e));
      });

      target.addEventListener("targetLost", () => {
        console.log("[MindAR] Marcador perdido.");
        video.pause();
        setStatus("‚è∏Ô∏è Marcador perdido. V√≠deo pausado.");
      });
    </script>
  </body>
</html>
