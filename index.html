<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cartão AR - Multi Vídeos (corrigido)</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
    }

    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.7);
      padding: 8px 14px;
      border-radius: 8px;
      z-index: 20;
      font-size: 14px;
      max-width: 92vw;
      text-align: center;
      line-height: 1.35;
    }

    #gate {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: #000;
      color: #fff;
      z-index: 30;
    }

    #gate button {
      padding: 12px 18px;
      border: 0;
      border-radius: 10px;
      background: #22c55e;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    a-scene { width: 100vw; height: 100vh; }
  </style>
</head>

<body>

  <div id="status">Toque em Iniciar…</div>

  <div id="gate">
    <h2>Cartão AR</h2>
    <p>Toque para habilitar o som e iniciar a câmera</p>
    <button id="btnStart">Iniciar</button>
  </div>

  <a-scene
    id="scene"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets id="assets"></a-assets>
    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity id="anchors"></a-entity>

  </a-scene>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQaVmj1MBbIoOCod-vRZvG1Z4DGxo3ZO4",
      authDomain: "cartao-ar-clientes.firebaseapp.com",
      projectId: "cartao-ar-clientes",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.buscarVideosCliente = async function(cliente) {
      const ref = doc(db, "clientes", cliente);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return snap.data();
    };
  </script>

  <!-- MINDAR + VÍDEOS (corrigido: sem escala manual) -->
  <script>
    const statusEl  = document.getElementById("status");
    const gateEl    = document.getElementById("gate");
    const sceneEl   = document.getElementById("scene");
    const assetsEl  = document.getElementById("assets");
    const anchorsEl = document.getElementById("anchors");
    const btnStart  = document.getElementById("btnStart");

    function setStatus(t) {
      statusEl.textContent = t;
      console.log("[STATUS]", t);
    }

    let audioEnabled = false;

    // Aspect ratios calculados a partir das imagens que você usou ao gerar o .mind
    // (use exatamente os valores usados para criar o target.mind)
    const TARGET_ASPECTS = {
      "0": 890 / 615,    // exemplo: imagem 1
      "1": 1728 / 2185   // exemplo: imagem 2
    };

    // Altura base do target (MindAR normaliza o target para altura = 1.0)
    const TARGET_HEIGHT = 1.0;

    // Desbloqueio de áudio
    btnStart.onclick = async () => {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) {
        window._ctx = window._ctx || new AC();
        if (window._ctx.state !== "running") await window._ctx.resume();
      }
      audioEnabled = true;
      gateEl.style.display = "none";
      setStatus("Som habilitado. Aponte o cartão.");
    };

    async function iniciar() {
      const params = new URLSearchParams(location.search);
      const cliente = (params.get("cliente") || "").trim().toLowerCase();

      if (!cliente) {
        setStatus("Erro: use ?cliente=nome");
        return;
      }

      const mindPath = `mindar/${cliente}.mind`;
      sceneEl.setAttribute("mindar-image", `imageTargetSrc: ${mindPath}`);

      setStatus("Carregando vídeos do cliente…");
      const dados = await window.buscarVideosCliente(cliente);

      if (!dados || !dados.videos) {
        setStatus("Nenhum vídeo encontrado.");
        return;
      }

      const videoMap = dados.videos;
      const keys = Object.keys(videoMap);

      setStatus(`${keys.length} vídeo(s) encontrados.`);

      keys.forEach(k => {
        const url = videoMap[k];
        const vidId = `video_${k}`;

        // Vídeo (colocado em assets)
        const v = document.createElement("video");
        v.id = vidId;
        v.src = url;
        v.loop = true;
        v.preload = "auto";
        v.crossOrigin = "anonymous";
        v.setAttribute("playsinline", "");
        // Alguns navegadores exigem muted para permitir autoplay; deixamos não-muted, mas só desmutamos quando o botão iniciar foi pressionado
        v.muted = true;
        assetsEl.appendChild(v);

        // Anchor para o targetIndex
        const anchor = document.createElement("a-entity");
        anchor.setAttribute("mindar-image-target", `targetIndex: ${k}`);
        anchorsEl.appendChild(anchor);

        // --- CORREÇÃO PRINCIPAL: usar ALTURA = TARGET_HEIGHT (1.0) E largura = aspect * altura ---
        const aspectRatio = TARGET_ASPECTS[k] || 1.0;
        const videoHeight = TARGET_HEIGHT;                  // altura = 1.0 (padrão MindAR)
        const videoWidth  = TARGET_HEIGHT * aspectRatio;    // largura baseada apenas no aspect ratio

        // Plano do vídeo (colocado levemente à frente do target)
        const plane = document.createElement("a-plane");
        plane.setAttribute("src", `#${vidId}`);
        plane.setAttribute("position", "0 0 0.005");
        plane.setAttribute("width",  videoWidth.toFixed(4));
        plane.setAttribute("height", videoHeight.toFixed(4));
        plane.setAttribute("material", "shader: flat;");
        anchor.appendChild(plane);

        // (opcional) fundo atrás do vídeo — mantém contraste
        const backgroundPlane = document.createElement("a-plane");
        backgroundPlane.setAttribute("width",  videoWidth.toFixed(4));
        backgroundPlane.setAttribute("height", videoHeight.toFixed(4));
        backgroundPlane.setAttribute("position", "0 0 -0.005");
        backgroundPlane.setAttribute("color", "#222");
        anchor.appendChild(backgroundPlane);

        // Eventos de reprodução/pause
        anchor.addEventListener("targetFound", async () => {
          // Desmuta somente se o usuário já permitiu som
          if (audioEnabled) v.muted = false;
          try { await v.play(); } catch (e) { console.warn("Erro ao reproduzir vídeo:", e); }
        });

        anchor.addEventListener("targetLost", () => {
          v.pause();
        });
      });

      setStatus("Pronto! Aponte o cartão.");
    }

    window.addEventListener("DOMContentLoaded", iniciar);
  </script>

</body>
</html>

