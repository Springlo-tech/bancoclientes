<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart√£o AR Cliente - MindAR (cliente √∫nico + economia)</title>

  <!-- A-Frame e MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; color:#fff; font-family:system-ui,sans-serif; }
    #status {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.7); padding:8px 14px; border-radius:8px; z-index:20; font-size:14px;
      max-width:92vw; text-align:center; line-height:1.35;
    }
    #gate {
      position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:12px; background:#000; color:#fff; z-index:30;
    }
    #gate button{
      padding:12px 18px; border:0; border-radius:10px; background:#22c55e; color:#fff; font-weight:700; cursor:pointer;
    }
    a-scene { width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div id="status">Toque em ‚ÄúIniciar‚Äù para habilitar o som‚Ä¶</div>

  <!-- Tela inicial para gesto do usu√°rio (desbloqueia √°udio) -->
  <div id="gate">
    <h2 style="margin:0">üéÑ Cart√£o AR</h2>
    <p style="opacity:.8; margin:0 16px; text-align:center">Toque para habilitar o som e iniciar a c√¢mera</p>
    <button id="btnStart">Iniciar</button>
  </div>

  <!-- Cena SEM mindar-image inicialmente (vamos setar dinamicamente) -->
  <a-scene id="scene"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets id="assets"></a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- O entity do target ser√° criado dinamicamente -->
  </a-scene>

  <!-- Firebase (expondo fun√ß√£o global) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQaVmj1MBbIoOCod-vRZvG1Z4DGxo3ZO4",
      authDomain: "cartao-ar-clientes.firebaseapp.com",
      projectId: "cartao-ar-clientes",
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    window.buscarVideoCliente = async function(nomeCliente) {
      const q = query(collection(db, "clientes"), where("nome", "==", nomeCliente));
      const snapshot = await getDocs(q);
      if (snapshot.empty) throw new Error(`Cliente '${nomeCliente}' n√£o encontrado no Firestore`);
      return snapshot.docs[0].data(); // campo 'videourl'
    };
  </script>

  <!-- L√≥gica principal -->
  <script>
    const statusEl = document.getElementById('status');
    const sceneEl  = document.getElementById('scene');
    const assetsEl = document.getElementById('assets');
    const gateEl   = document.getElementById('gate');
    const btnStart = document.getElementById('btnStart');

    function setStatus(msg){ statusEl.textContent = msg; console.log('[STATUS]', msg); }

    // === 1) Descobre o cliente pela URL e define o arquivo .mind correspondente ===
    const params = new URLSearchParams(location.search);
    const clienteParam = (params.get('cliente') || '').trim();
    // Mapeie aqui seus nomes -> arquivos .mind
    const mindMap = {
      'INGRID': 'ingrid.mind',
      'LAURA' : 'laura.mind'
    };
    const nomeCliente = clienteParam.toUpperCase();
    const mindFile = mindMap[nomeCliente];

    if (!mindFile) {
      setStatus('Informe ?cliente=Ingrid ou ?cliente=Laura na URL.');
    }

    // === 2) Desbloqueia √°udio no primeiro toque ===
    window.soundUnlocked = false;
    btnStart.addEventListener('click', async () => {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          if (!window._audioCtx) window._audioCtx = new AC();
          if (window._audioCtx.state !== 'running') await window._audioCtx.resume();
        }
        window.soundUnlocked = true;
        gateEl.style.display = 'none';
        setStatus('Som habilitado. Aponte para a imagem para iniciar o v√≠deo.');
      } catch (e) {
        console.warn('Falha ao desbloquear √°udio:', e);
        setStatus('N√£o consegui habilitar o √°udio. Tente novamente.');
      }
    });

    // === 3) Componente que cria o v√≠deo e o plano ajustado ===
    AFRAME.registerComponent('cliente-ar', {
      schema: { nomeCliente:{type:'string'}, videoId:{type:'string'} },

      init: function () {
        const { nomeCliente, videoId } = this.data;
        const targetEl = this.el;

        setStatus(`Buscando v√≠deo de ${nomeCliente}‚Ä¶`);
        window.buscarVideoCliente(nomeCliente)
          .then(dados => {
            const url = dados.videourl;
            console.log(`üé¨ URL de ${nomeCliente}:`, url);
            if (!url) { setStatus(`Erro: 'videourl' do cliente ${nomeCliente} est√° vazio.`); return; }

            const v = document.createElement('video');
            v.id = videoId;
            v.src = url;
            v.preload = 'auto';
            v.muted = !window.soundUnlocked; // som liga ap√≥s clique
            v.setAttribute('playsinline','');
            v.setAttribute('webkit-playsinline','');
            v.loop = true;
            v.crossOrigin = 'anonymous';
            assetsEl.appendChild(v);

            v.addEventListener('loadedmetadata', () => {
              this.adicionarVideoPlane(v);
              setStatus(`V√≠deo de ${nomeCliente} carregado. Aponte a c√¢mera.`);
            });

            targetEl.addEventListener('targetFound', async () => {
              console.log(`üéØ ${nomeCliente} rastreado`);
              if (window.soundUnlocked) v.muted = false;
              try { await v.play(); } catch (err) { console.error('Play falhou:', err); }
            });

            targetEl.addEventListener('targetLost', () => {
              console.log(`‚ùå ${nomeCliente} perdido`);
              v.pause();
            });

            v.load();
          })
          .catch(err => {
            console.error(`Erro ao buscar ${nomeCliente}:`, err);
            setStatus(`Erro ao carregar ${nomeCliente}: ${err.message}`);
          });
      },

      adicionarVideoPlane: function (videoEl) {
        const { videoId, nomeCliente } = this.data;
        const plane = document.createElement('a-plane');

        plane.setAttribute('src', `#${videoId}`);
        plane.setAttribute('crossorigin', 'anonymous');
        plane.setAttribute('material', 'shader: flat; transparent: true; opacity: 1;');
        plane.setAttribute('position', '0 0 0.05');

        const aspect = videoEl.videoWidth / videoEl.videoHeight;
        const baseHeight = 1.0;
        const baseWidth  = baseHeight * aspect;

        plane.setAttribute('height', baseHeight.toString());
        plane.setAttribute('width',  baseWidth.toString());
        this.el.appendChild(plane);
        console.log(`‚úÖ Plano de v√≠deo para ${nomeCliente} adicionado (aspect=${aspect.toFixed(3)})`);
      }
    });

    // === 4) Monta a cena s√≥ para o cliente escolhido (economia de egress) ===
    (function montarCenaParaUmCliente(){
      if (!mindFile) return; // j√° mostramos status pedindo ?cliente=
      // Seta o .mind correto
      sceneEl.setAttribute('mindar-image', `imageTargetSrc: ./mindar/${mindFile}; filterMinCF: 0.1; filterBeta: 10`);

      // Cria o √∫nico target (index 0) com o componente do cliente
      const entity = document.createElement('a-entity');
      entity.setAttribute('mindar-image-target', 'targetIndex: 0');
      entity.setAttribute('cliente-ar', `nomeCliente: ${clienteParam}; videoId: videoDoCliente`);
      sceneEl.appendChild(entity);
    })();
  </script>
</body>
</html>

